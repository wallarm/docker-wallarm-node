.x-export-image-name: &x_export_image_name
  - echo "NODE_DOCKER_IMAGE=${NODE_DOCKER_IMAGE}" >> variables.env
  - echo "IMAGE_TAG=${IMAGE_TAG}" >> variables.env

.x-docker-login-private: &x_docker_login_private
  - | # GitLab Container Registry
    docker login "${CI_REGISTRY}" \
        -u "${CI_REGISTRY_USER}" \
        -p "${CI_REGISTRY_PASSWORD}"
  - | # GitLab Dependency Proxy
    docker login "${CI_DEPENDENCY_PROXY_SERVER}" \
        -u "${CI_DEPENDENCY_PROXY_USER}" \
        -p "${CI_DEPENDENCY_PROXY_PASSWORD}"

.x-docker-login-public: &x_docker_login_public
  - | # DockerHub
    docker login \
        -u "${X_CREDS_DOCKERHUB_WALLARMCICD_USER}" \
        -p "${X_CREDS_DOCKERHUB_WALLARMCICD_PASSWORD}"

.x-tools-build-deps: &x-tools-build-deps
  - |
    apk update
    apk add bash make git tar curl

.x-get-credentials: &x_get_credentials
  secrets:
    GITLAB_TOKEN: {vault: "pipelines/gl_version_repo_creds/token_secret@node-team", file: false}
    GITLAB_TOKEN_NAME: {vault: "pipelines/gl_version_repo_creds/token_name@node-team", file: false}
    GITLAB_HOST: {vault: "pipelines/gl_version_repo_creds/host@node-team", file: false}
    GITLAB_REPO: {vault: "pipelines/gl_version_repo_creds/repo@node-team", file: false}

.before-docker-build:
  before_script:
    - *x_docker_login_private
    - *x_export_image_name


.before-scout-scan:
  before_script:
    - *x-tools-build-deps
    - *x_docker_login_private
    - *x_docker_login_public

.before-sign-docker:
  before_script:
    - *x_docker_login_public
